# Scenario: Ranged Chains Synergy
# Purpose: Phase 22.2 - Observable test for Oath of Chains + Ranged Knockback interaction
#
# This scenario creates the conditions to observe Chains + ranged knockback synergy:
#   - Player has Oath of Chains (which normally adds +1 to knockback distance)
#   - Player uses a ranged weapon (shortbow)
#   - Many targets at optimal range to maximize ranged knockback procs
#
# Current state (Phase 22.2):
#   - Ranged knockback is fixed at 1 tile via apply_knockback_single_tile
#   - Chains bonus does NOT currently apply to ranged knockback
#   - This scenario serves as a smoke test to:
#     a) Verify ranged knockback procs > 0 with Chains equipped
#     b) Guard against future "Chains makes ranged broken" drift
#     c) Make the (non-)interaction observable in metrics
#
# Future consideration: Should Chains add +1 to ranged knockback?
# If we decide yes, update apply_ranged_knockback to use calculate_knockback_distance
# with a fixed base_distance=1 instead of apply_knockback_single_tile.
#
# Deterministic under seed_base=1337

metadata:
  scenario_id: ranged_chains_synergy
  family: ranged_tests
  depth: 2

scenario_id: ranged_chains_synergy
name: "Ranged Chains Synergy Arena"
description: "Observe Oath of Chains + ranged knockback interaction (smoke test)."

depth: 2

defaults:
  turn_limit: 80
  player_bot: "tactical_fighter"
  allow_player_death: true
  runs: 20  # More runs to statistically observe the 10% proc

expected:
  # Smoke test thresholds - verify ranged knockback procs with Chains
  # At 10% proc rate over ~80 turns with 4 targets, we expect some procs
  min_ranged_attacks_made_by_player: 10
  min_ranged_knockback_procs: 1  # At least one proc across 20 runs
  min_knockback_tiles_moved_by_player: 0  # Currently 0 since ranged KB doesn't add to this (yet)
  
  # Note: If we later make Chains affect ranged knockback, update these thresholds
  # and verify knockback_tiles_moved_by_player increases vs non-chains baseline

suites:
  - ranged_tests
  - identity

rooms:
  - id: "chains_arena"
    type: "arena"
    width: 20
    height: 12
    description: "Arena for testing Chains + ranged knockback synergy"
    walls: "enclosed"

monsters:
  # Multiple targets at optimal range (4-6 tiles) to maximize ranged attack opportunities
  # This increases chances of observing the 10% knockback proc
  - type: "orc"
    count: 1
    position: [9, 6]   # distance 4 from player at [5, 6]
    facing: "west"
    state: "aware"
  - type: "orc"
    count: 1
    position: [10, 4]  # distance ~5 from player
    facing: "southwest"
    state: "aware"
  - type: "orc"
    count: 1
    position: [10, 8]  # distance ~5 from player
    facing: "northwest"
    state: "aware"
  - type: "orc"
    count: 1
    position: [11, 6]  # distance 6 from player
    facing: "west"
    state: "aware"

items:
  # Extra healing to extend combat and maximize ranged attack opportunities
  - type: "healing_potion"
    count: 5
    position: [2, 2]
  - type: "healing_potion"
    count: 5
    position: [17, 9]
  - type: "healing_potion"
    count: 3
    position: [5, 2]

player:
  oath: "chains"  # Phase 22.1: Oath of Chains applied
  position: [5, 6]
  facing: "east"
  inventory: []
  equipment:
    weapon: "shortbow"  # Ranged weapon with reach 8
    armor: "leather_armor"

# Scenario design notes (Phase 22.2 - Chains + Ranged Synergy):
# - Player starts at [5, 6] with shortbow + Oath of Chains
# - 4 orcs at optimal range to maximize ranged combat
# - Expected behavior:
#   - Player makes many ranged attacks at optimal range
#   - 10% of successful hits trigger 1-tile knockback
#   - Currently, Chains does NOT add to ranged knockback distance
#   - Metrics track: ranged_knockback_procs, knockback_tiles_moved_by_player
#
# FUTURE WORK: If Chains should affect ranged knockback, modify
# apply_ranged_knockback to use calculate_knockback_distance(base=1, attacker)
# instead of the fixed apply_knockback_single_tile call.
