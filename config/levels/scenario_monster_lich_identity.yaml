# Scenario: Lich Identity Kit (Phase 19)
# Purpose: Regression anchor for Phase 19 lich identity mechanics:
#   - Soul Bolt: 2-turn telegraph + resolve (35% max HP damage, 4-turn cooldown)
#   - Soul Ward: Reduces Soul Bolt damage by 70%, converts to 3-turn Soul Burn DOT
#   - Command the Dead: Allied undead within radius 6 get +1 to-hit
#   - Death Siphon: Lich heals 2 HP when allied undead dies within radius 6
#
# This scenario is deterministic and suitable for ongoing regression validation.

metadata:
  scenario_id: monster_lich_identity
  family: ability_tests
  depth: 5

scenario_id: monster_lich_identity
name: "Lich Identity Kit (Phase 19)"
description: "Validate Phase 19 lich Soul Bolt, Soul Ward, Command the Dead, and Death Siphon mechanics."

depth: 5

defaults:
  turn_limit: 300
  player_bot: "tactical_fighter"
  allow_player_death: true
  runs: 30

expected:
  min_player_kills: 40  # 1 lich + 4 skeleton allies per run × 30 runs (conservative)
  max_player_deaths: 15  # Lich is dangerous with Soul Bolt but ward + tactics help

rooms:
  - id: "lich_arena"
    type: "arena"
    width: 17
    height: 17
    description: "Arena for testing lich Soul Bolt, Command the Dead, and Death Siphon"
    walls: "enclosed"

monsters:
  # 1 Lich (elite controller)
  # Stats: HP=80, Soul Bolt=ceil(0.35 * player.max_hp), Command aura=+1 to-hit for undead
  # Positioned at back to survive long enough to cast Soul Bolt
  - type: "lich"
    count: 1
    position: [15, 8]
    facing: "west"
    state: "aware"
  
  # 4 Skeletons (test Command the Dead + Death Siphon)
  # Skeletons are undead faction, will benefit from lich's +1 to-hit aura
  # When skeletons die, lich should heal 2 HP each via Death Siphon
  - type: "skeleton"
    count: 1
    position: [11, 6]
    facing: "west"
    state: "aware"
  - type: "skeleton"
    count: 1
    position: [11, 10]
    facing: "west"
    state: "aware"
  - type: "skeleton"
    count: 1
    position: [13, 6]
    facing: "west"
    state: "aware"
  - type: "skeleton"
    count: 1
    position: [13, 10]
    facing: "west"
    state: "aware"

items:
  # Soul Ward scrolls: primary counter to Soul Bolt
  # Player should use these when lich starts charging
  - type: "scroll_soul_ward"
    count: 2
    position: [3, 7]
  
  # Healing potions: sustain combat for Soul Bolt + multiple enemies
  - type: "healing_potion"
    count: 4
    position: [3, 9]
  
  # Weapon upgrade for dealing with skeletons efficiently
  - type: "longsword"
    count: 1
    position: [3, 11]
  
  # Ranged weapon for interrupting lich (throwing daggers)
  - type: "dagger"
    count: 3
    position: [3, 5]

player:
  position: [3, 8]
  facing: "east"
  inventory: []
  equipment:
    weapon: "dagger"  # Weak starting weapon
    armor: null  # No armor - ensures Soul Bolt deals predictable damage

# Scenario design notes (Phase 19 - Lich Identity):
# - 1 lich + 4 skeletons in 17x17 arena
# - Lich positioned at back (13, 8), skeletons guard flanks
# - Player starts with basic dagger + equipment scattered
#
# Expected behavior:
#   A) Soul Bolt mechanics:
#      - Lich charges (turn 1): "channeling dark energy" message
#      - Lich resolves (turn 2): Soul Bolt deals ceil(0.35 * 54) = 19 damage
#      - Cooldown: 4 turns after resolution
#   
#   B) Soul Ward mechanics:
#      - Player uses scroll_soul_ward (10 turn duration)
#      - When Soul Bolt hits with ward active:
#        - Upfront damage: ceil(19 * 0.30) = 6 damage
#        - Soul Burn DOT: 13 damage over 3 turns (4-4-5 split)
#   
#   C) Command the Dead:
#      - Skeletons within radius 6 of lich get +1 to-hit
#      - Should increase skeleton hit rate measurably
#   
#   D) Death Siphon:
#      - When skeleton dies within radius 6, lich heals 2 HP
#      - Should trigger 4 times per run (one per skeleton)
#
# Metrics validation (added to balance suite):
# - lich_soul_bolt_charges: Charges started
# - lich_soul_bolt_casts: Bolts resolved (successful casts)
# - soul_ward_blocks: Soul Bolts that hit while ward active
# - lich_death_siphon_heals: Death Siphon triggers
# - lich_raise_successes: Corpses raised (if lich raises skeletons)
#
# Minimum expectations (30 runs):
# - lich_soul_bolt_casts >= 20 (frequent casting)
# - soul_ward_blocks >= 15 (player uses scrolls tactically)
# - lich_death_siphon_heals >= 60 (4 skeletons × ~15 runs where they die first)
# - Player deaths <= 15 (lich dangerous but counterable)



