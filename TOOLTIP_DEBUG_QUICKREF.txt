================================================================================
TOOLTIP FLICKER DEBUG — QUICK REFERENCE CARD
================================================================================

SETUP (one-time)
================
1. python3 test_tooltip_instrumentation.py          # Verify instrumentation
2. Edit logger_config.py: change logging.WARNING → logging.DEBUG
3. Edit ui/debug_flags.py: ENABLE_TOOLTIP_DEBUG = True (already enabled)

REPRODUCE FLICKER
=================
1. Start game
2. Kill first orc, hover corpse+loot (baseline, usually stable)
3. Kill second orc, hover corpse+loot (flicker starts)
4. Keep logs/rlike.log open: tail -f logs/rlike.log | grep TOOLTIP_

CAPTURE LOGS
============
When flicker is visible:
  tail -n 200 logs/rlike.log | grep TOOLTIP_ > /tmp/flicker_logs.txt

QUICK DIAGNOSTICS
==================
Check these patterns in logs:

1. ENTITY LIST FLAPS?
   Look for: TOOLTIP_ENTITIES_FINAL alternating between different counts/names
   Fix: FOV or coordinate mapping instability

2. ENTITY ORDER FLAPS?
   Look for: Same count but different order each frame
   Fix: Entity sorting non-determinism

3. TOOLTIP CONTENT CHANGES?
   Look for: TOOLTIP_SINGLE_CONTENT or TOOLTIP_MULTI_CONTENT changing
   Fix: Usually caused by entity list flapping

4. GEOMETRY FLAPS?
   Look for: TOOLTIP_*_GEOM x/y/w/h changing
   Fix: Tooltip sizing or boundary clamping logic

5. MISSING DRAWS?
   Look for: Some frames missing TOOLTIP_DRAW_CALL
   Fix: Conditional rendering logic flapping

ISOLATION EXPERIMENTS
=====================
To find root cause, try these one at a time:

Experiment 1 — Disable FOV:
  Edit ui/debug_flags.py: TOOLTIP_IGNORE_FOV = True
  Does flicker disappear? → FOV is the problem
  
Experiment 2 — Disable Effects:
  Edit ui/debug_flags.py: TOOLTIP_DISABLE_EFFECTS = True
  Does flicker disappear? → Effects are interfering

ANALYZE LOG FORMAT
==================
All tooltip logs start with frame ID:
  TOOLTIP_XXX: frame=NNN [other fields...]

Per-frame trace for stable tooltip should show identical values each frame.
If ANY value alternates → that's your flicker cause.

Example stable pattern (frames 100-102):
  frame=100: entities=['Orc Corpse'], geom=x:52 y:21 w:15 h:3
  frame=101: entities=['Orc Corpse'], geom=x:52 y:21 w:15 h:3  ← SAME
  frame=102: entities=['Orc Corpse'], geom=x:52 y:21 w:15 h:3  ← SAME

Example flicker pattern (frames 100-102):
  frame=100: entities=['Orc Corpse', 'Longsword']
  frame=101: entities=[]                           ← CHANGED! (flicker)
  frame=102: entities=['Orc Corpse', 'Longsword']  ← BACK TO BEFORE

DEBUG FLAGS (ui/debug_flags.py)
===============================
ENABLE_TOOLTIP_DEBUG     → Master switch (True = full logging)
TOOLTIP_IGNORE_FOV       → Bypass FOV checks for testing
TOOLTIP_DISABLE_EFFECTS  → Skip visual effects for testing

DISABLE WHEN DONE
=================
Edit ui/debug_flags.py:
  ENABLE_TOOLTIP_DEBUG = False      # Disable all tooltip logging
  TOOLTIP_IGNORE_FOV = False        # Restore normal FOV
  TOOLTIP_DISABLE_EFFECTS = False   # Restore normal effects

DOCUMENTATION
==============
Detailed Guide:    TOOLTIP_DEBUG_INSTRUMENTATION.md
Full Summary:      INSTRUMENTATION_SUMMARY.md
This Quick Ref:    TOOLTIP_DEBUG_QUICKREF.txt
Verification:      test_tooltip_instrumentation.py

LOGGING LOCATIONS
=================
logs/rlike.log          ← Main log (10 MB rotation, keep 5)
logs/rlike_errors.log   ← Errors only (5 MB rotation, keep 3)

KEY LOGGING POINTS
==================
TOOLTIP_VIEWPORT_START       → Mouse entered viewport, coords translated
TOOLTIP_FOV_CHECK            → FOV visibility determined
TOOLTIP_ENTITY_CLASSIFIED    → Entity classification (corpse/monster/item)
TOOLTIP_ENTITIES_FINAL       → Final stable entity list
TOOLTIP_VIEWPORT_ENTITIES    → Entities before rendering decision
TOOLTIP_DRAW_CALL            → About to draw tooltip (kind=single|multi)
TOOLTIP_SINGLE_CONTENT       → Single-entity tooltip text
TOOLTIP_SINGLE_GEOM          → Single-entity tooltip position/size
TOOLTIP_MULTI_ENTITY         → Multi-entity list
TOOLTIP_MULTI_CONTENT        → Multi-entity tooltip text
TOOLTIP_MULTI_GEOM           → Multi-entity tooltip position/size

COMMON ISSUES
=============
Q: No TOOLTIP_ logs appearing?
A: Check that ENABLE_TOOLTIP_DEBUG=True and logging level is DEBUG

Q: Performance degradation?
A: Only happens with ENABLE_TOOLTIP_DEBUG=True. Set to False when done.

Q: Logs too verbose?
A: Use grep to filter: tail logs/rlike.log | grep TOOLTIP_ENTITIES_FINAL

Q: Can't find the flicker?
A: Try with TOOLTIP_DISABLE_EFFECTS=True to see if effects are confusing it

REPORT FINDINGS
===============
When filing a bug, include:
1. Exact steps to reproduce (what kills the flicker pattern?)
2. 20-30 frame log excerpt showing the flicker
3. Which isolation experiment helped most
4. Which TOOLTIP_* values were flapping

================================================================================
For detailed usage: see INSTRUMENTATION_SUMMARY.md
================================================================================


